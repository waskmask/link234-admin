<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('partials/head', { title }) %>
    <style>
      .num {
        font-variant-numeric: tabular-nums;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col bg-gray-50 text-gray-800">
    <%- include('partials/accHeader') %>

    <main class="flex-1 mx-auto w-full max-w-[1500px] pb-[80px] px-4 py-6">
      <div class="flex items-center gap-3 mb-6">
        <h1 class="text-2xl font-semibold">Dashboard</h1>
      </div>

      <% if (typeof error !== 'undefined' && error) { %>
      <div
        class="mb-4 rounded-lg border border-rose-200 bg-rose-50 text-rose-800 px-4 py-2 text-sm"
      >
        <%= error %>
      </div>
      <% } %>

      <!-- Expose data for the client (chart rendering) -->

      <script>
        window.__DASHBOARD__ = JSON.parse(
          decodeURIComponent(
            "<%- encodeURIComponent(JSON.stringify(dashboard || {}, null, 0)) %>"
          )
        );
      </script>
      <!-- KPI Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Users Total -->
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <div class="text-sm text-gray-500">Users</div>
          <div class="mt-1 text-2xl font-semibold num" id="kpi_usersTotal">
            —
          </div>
          <div class="mt-2 text-xs text-gray-500">
            Active: <span class="num" id="kpi_usersActive">—</span> · Inactive:
            <span class="num" id="kpi_usersInactive">—</span>
          </div>
        </div>

        <!-- Verification -->
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <div class="text-sm text-gray-500">Email verification</div>
          <div class="mt-1 text-2xl font-semibold num" id="kpi_usersVerified">
            —
          </div>
          <div class="mt-2 text-xs text-gray-500">
            Unverified: <span class="num" id="kpi_usersUnverified">—</span>
          </div>
        </div>

        <!-- Purchases -->
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <div class="text-sm text-gray-500">Live Paid Purchases</div>
          <div class="mt-1 text-2xl font-semibold num" id="kpi_purchasesTotal">
            —
          </div>
          <div class="mt-2 text-xs text-gray-500">
            Forms: <span class="num" id="kpi_formsTotal">—</span> · Coupons:
            <span class="num" id="kpi_couponsTotal">—</span>
          </div>
        </div>

        <!-- Revenue (all currencies) -->
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <div class="text-sm text-gray-500">Revenue</div>
          <div
            class="mt-1 text-2xl font-semibold num"
            id="kpi_revenueMinorTotal"
          >
            —
          </div>
          <div class="mt-2 text-xs text-gray-500" id="kpi_revenueByCurrency">
            —
          </div>
        </div>
      </div>

      <!-- Users per month chart + revenue breakdown -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Chart -->
        <div
          class="lg:col-span-2 rounded-xl border border-gray-200 bg-white p-4 shadow-sm"
        >
          <div class="flex items-center justify-between mb-3">
            <div class="font-semibold">Users per Month</div>
          </div>
          <div class="relative h-64">
            <!-- h-64 ≈ 256px; tweak as you like -->
            <canvas id="usersChart"></canvas>
          </div>
        </div>

        <!-- Breakdown table -->
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <div class="font-semibold mb-3">Revenue by Region & Currency</div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="text-left text-gray-600">
                <tr>
                  <th class="py-2">Region</th>
                  <th class="py-2">Currency</th>
                  <th class="py-2">Transactions</th>
                  <th class="py-2">Total</th>
                </tr>
              </thead>
              <tbody
                id="rev_tbody"
                class="divide-y divide-gray-100 text-gray-800"
              >
                <!-- rows injected -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <%- include('partials/footer') %>
    <script src="/public/js/axios.min.js"></script>
    <!-- Chart.js (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="/public/js/dashboard.js"></script>
  </body>
</html>
